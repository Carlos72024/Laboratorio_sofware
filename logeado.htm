<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>TutorGo - Logueado</title>
</head>
<body>
    <header>
        <h1>TutorGo - Bienvenido</h1>
        <div id="usuarioNombre" style="float: right; margin-top: 10px;"></div>
        <nav>
            <ul>
                <li><a href="registrar_tutoria.html">Registrar Tutoría</a></li>
                <li><a href="ver_tutorias.html">Ver tus Tutorías</a></li>
                <li><a href="sugerir_tutoria.html">Sugerir Tutoría</a></li>
                <li><a href="calendario.html">Calendario</a></li>
                <li><a href="index.html">Inicio</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <section>
            <h2>Tutorías Disponibles</h2>
            <div class="tutoria-container" id="disponiblesContainer">
                <table>
                    <thead>
                        <tr>
                            <th>Seleccionar</th>
                            <th>Materia</th>
                            <th>Tema</th>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Lugar</th>
                            <th>Observaciones</th>
                            <th>Tutor</th>
                        </tr>
                    </thead>
                    <tbody id="tutoriasDisponibles"></tbody>
                </table>
                <button id="agregarTutorias">Agregar Tutorías Seleccionadas</button>
            </div>
        </section>
        <section>
            <h2>Tutorías Inscritas</h2>
            <div class="tutoria-container" id="inscritasContainer">
                <table>
                    <thead>
                        <tr>
                            <th>Materia</th>
                            <th>Tema</th>
                            <th>Tutor</th>
                            <th>Eliminar</th>
                        </tr>
                    </thead>
                    <tbody id="tutoriasInscritas"></tbody>
                </table>
                <button id="eliminarTutorias">Eliminar Tutorías Seleccionadas</button>
            </div>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, getDocs, collection, setDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDeSaRhTuUCb7u2M4zK-yY7lCCjc-AIIKw",
            authDomain: "tutorgo-64a6f.firebaseapp.com",
            projectId: "tutorgo-64a6f",
            storageBucket: "tutorgo-64a6f.firebasestorage.app",
            messagingSenderId: "108547172978",
            appId: "1:108547172978:web:296b32fab2a6ccbd44f0eb",
            measurementId: "G-YQGWDYJYJS"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let tutoriasInscritas = [];

        // Mostrar el nombre del usuario logueado
        const aliasUsuario = localStorage.getItem('usuarioAlias'); // Obtener el alias
        document.getElementById('usuarioNombre').textContent = `Usuario: ${aliasUsuario}`; // Mostrar el nombre

        async function cargarTutorias() {
            const tutoriasRef = collection(db, 'tutorias');
            const snapshot = await getDocs(tutoriasRef);
            const listaTutorias = document.getElementById('tutoriasDisponibles');

            snapshot.forEach(doc => {
                const data = doc.data();
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" value="${data.materia}-${data.tema}" /></td>
                    <td>${data.materia}</td>
                    <td>${data.tema}</td>
                    <td>${data.fecha}</td>
                    <td>${data.hora}</td>
                    <td>${data.lugar}</td>
                    <td>${data.observaciones}</td>
                    <td>${data.tutor}</td>
                `;
                listaTutorias.appendChild(row);
            });
        }

        document.getElementById('agregarTutorias').addEventListener('click', async function() {
            const checkboxes = document.querySelectorAll('#tutoriasDisponibles input[type="checkbox"]:checked');
            checkboxes.forEach(async (checkbox) => {
                const [materia, tema] = checkbox.value.split('-');
                if (!tutoriasInscritas.some(t => t.materia === materia && t.tema === tema)) {
                    tutoriasInscritas.push({ materia, tema });
                    const row = document.createElement('tr');
                    const tutor = checkbox.closest('tr').children[7].textContent; // Obtener el tutor
                    row.innerHTML = `
                        <td>${materia}</td>
                        <td>${tema}</td>
                        <td>${aliasUsuario}</td> <!-- Agregar el alias del usuario -->
                        <td><button class="eliminar">Eliminar</button></td>
                    `;
                    document.getElementById('tutoriasInscritas').appendChild(row);

                    // Guardar en Firestore
                    const tutoriasRef = doc(db, 'tutoriasInscritas', `${materia}-${tema}`);
                    await setDoc(tutoriasRef, {
                        materia: materia,
                        tema: tema,
                        tutor: aliasUsuario, // Guardar el alias del usuario
                        fecha: new Date().toISOString(), // Fecha de inscripción
                        // Puedes agregar más campos si es necesario
                    });
                }
            });
        });

        document.getElementById('eliminarTutorias').addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('#tutoriasInscritas .eliminar');
            checkboxes.forEach(button => {
                const row = button.closest('tr');
                row.remove();
                const materiaTema = row.children[0].textContent + '-' + row.children[1].textContent;
                tutoriasInscritas = tutoriasInscritas.filter(t => t.materia + '-' + t.tema !== materiaTema);
            });
        });

        cargarTutorias();
    </script>
</body>
</html>
